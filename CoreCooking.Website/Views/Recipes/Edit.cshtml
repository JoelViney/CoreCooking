@model CoreCooking.Website.ViewModels.Recipes.RecipeEditViewModel
@using CoreCooking.Website.Helpers

<ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="@UrlBuilder.GetCategoryUrl(Model)">@(Model.CategoryName)</a></li>
    @if (Model.IsNew())
    {
        <li>Add Recipe</li>
    }
    else
    {
        <li><a href="/Recipes/View?guid=@(Model.Guid)">@(Model.Name)</a></li>
        <li>Edit</li>
    }
</ol>

<form asp-controller="Recipes" asp-action="Edit" method="post">

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            @if (!Model.IsNew())
            {
                <div class="navbar-nav navbar-left">
                    <a href="@UrlBuilder.GetUrl(Model, "Delete")" class="btn btn-default navbar-btn btn-sm">Delete</a>
                </div>
            }
            <div class="navbar-nav navbar-right">
                <input type="submit" value="Save" class="btn btn-default btn-sm" />
                @if (Model.IsNew())
                {
                    <a href="@UrlBuilder.GetCategoryUrl(Model)" class="btn btn-default navbar-btn btn-sm">Cancel</a>
                }
                else
                {
                    <a href="@UrlBuilder.GetUrl(Model)" class="btn btn-default navbar-btn btn-sm">Cancel</a>
                }
            </div>
        </div>
    </nav>

    <h1>@(Model.Name)</h1>

    <input asp-for="ImageUrl" type="hidden">
    <input asp-for="CategoryGuid" type="hidden">
    <input asp-for="Guid" type="hidden">

    <div class="row">
        <div class="form-group col-md-6">
            <label asp-for="Name" class="col-md-2 control-label"></label>
            <input asp-for="Name" class="form-control" />
        </div>

        <div class="form-group">
            <div class="pull-left">
                <img id="imgUrl" src="@Url.Content(Model.ImageUrl)" class="img-responsive img-rounded" style="max-width: 250px;" alt="@Url.Content(Model.ImageUrl)">
                <div>
                    <span class="btn btn-default btn-file image-button">
                        Upload Image<input type="file" id="uploadFileInput">
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">Ingredients</div>
                <div class="panel-body">
                    <div class="form-group">
                        <textarea asp-for="IngredientsText" class="form-control" style="height: 40em;"></textarea>
                        <span asp-validation-for="IngredientsText" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">Steps</div>
                <div class="panel-body">
                    <div class="form-group">
                        <textarea asp-for="StepsText" class="form-control" style="height: 40em;"></textarea>
                        <span asp-validation-for="StepsText" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-6">
            <div class="panel panel-default">
                <div class="panel-heading">Notes</div>
                <div class="panel-body">
                    <div class="form-group">
                        <textarea asp-for="Notes" class="form-control" style="height: 40em;"></textarea>
                        <span asp-validation-for="Notes" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script type='text/javascript'>

        $('#uploadFileInput').on('change', function (e) {
            uploadFile(e);
        });

        function uploadFile(e) {
            var files = e.target.files;

            if (files.length > 0) {
                if (window.FormData !== undefined) {
                    var formData = new FormData();
                    formData.append("file", files[0]);

                    $.ajax({
                        type: "POST",
                        url: '/Images/UploadFile',
                        contentType: false,
                        processData: false,
                        data: formData,
                        success: function (result) {
                            console.log(result);
                            $("#imgUrl").attr("src", result.url);
                            $("#imgUrl").attr("alt", result.url);
                            $("#ImageUrl").val(result.url);
                        },
                        error: function (xhr, status, p3, p4) {
                            var err = "Error " + " " + status + " " + p3 + " " + p4;
                            if (xhr.responseText && xhr.responseText[0] == "{")
                                err = JSON.parse(xhr.responseText).Message;
                            console.log(err);
                            alert(err);
                        }
                    });
                } else {
                    alert("This browser doesn't support HTML5 file uploads!");
                }
            }

        }

    </script>
}